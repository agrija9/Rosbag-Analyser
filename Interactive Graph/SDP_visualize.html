<!doctype html>
<html>
    <head>
        <title>Network</title>
        <script type="text/javascript" src="//unpkg.com/vis-timeline@latest/dist/vis-timeline-graph2d.min.js"></script>
        <link href="//unpkg.com/vis-timeline@latest/dist/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" href="styles.css">
        <style type="text/css">
            #mynetwork {
            width: 600px;
            height: 400px;
            border: 1px solid lightgray;
            }
            .column1 {
                float: left;
                width: 4%;
                text-align: center;

                /* Should be removed. Only for demonstration */
            }

            .column2 {
                float: left;
                width: 96%;

                /* Should be removed. Only for demonstration */
            }

                /* Clear floats after the columns */
            .row:after {
                content: "";
                display: table;
                clear: both;
            }
        </style>
    </head>

    <body>

        <h1 align="center">RosBag Reader</h1>
        <div align = "center">
            <p>Choose RosBag file for visualization : 
                <input type="file" name="my_file" id="my-file">
            </p>
        </div>
        <div align="center">
                <button id="mainButton" align="center" onclick="mainFunc()">Generate</button>
        </div>
        <p></p>
        <div class="row">
            <div class="column1">
                <p id="topicsLabel" style="display:none">Topics :</p>
            </div>
            <div class="column2">
                <div id="visualization" style="display:none"></div>
            </div>
          </div>
        <p></p>
        <div class="row">
            <div class="column">
                <p id="legendText" style="display:none">Legends :</p>
                <div id="legend"></div>
            </div>
            <div class="column">
                <p id="selectTopics" style="display:none">Select Topics :  <input type="checkbox" checked=true id="selectall" onclick="selectAll()"><label for="checkTopic"> select all</label></p>
                <div id="container"></div>
                <div align="center">
                    <button id="UpdateButton" style="display:none" align="center" onclick="updateGraph()">Update Graph</button>
                </div>
            </div>
          </div>
        </div>
        <p></p>

        <script type="text/javascript">
            
            var data_act;
            var visdata = new vis.DataSet();
            var checkbox_array = [];
            var labels = {};
            var stringTopic = [];

            async function mainFunc(){
                const file = 'Rosbag_Content.csv';
                data_act = await getDataToJson(file);
                var actual_data = JsonVisData(data_act, visdata, true);
                chart(actual_data);
                // document.getElementById("topicsLabel").style.display = "block"
                document.getElementById("mainButton").style.display = "none"
                document.getElementById("selectTopics").style.display = "block"
                document.getElementById("legendText").style.display = "block"
                document.getElementById("UpdateButton").style.display = "block"                
                document.getElementById("visualization").style.display = "block"                
            }

            function csvJSON(csv){
                var lines=csv.split("\n");
                var result = [];
                var headers=lines[0].split(",");
                for(var i=1;i<lines.length;i++){
                    var obj = {};
                    var currentline=lines[i].split(",");
                    for(var j=0;j<headers.length;j++){
                        obj[headers[j]] = currentline[j];
                    }
                    result.push(obj);
                }
                return JSON.stringify(result); //JSON
            }

            async function updateGraph(){
                var new_data_act = Array.from(data_act);
                stringTopic.forEach(item => {
                    new_data_act.forEach(row => {
                        new_data_act=new_data_act.filter(function(itm){return itm.Topic!==item.substring(6,)});
                    });
                });
                console.log(new_data_act);
                var actual_data = JsonVisData(new_data_act, visdata, false);
                chart(actual_data);
                return new_data_act;
            }

            async function getDataToJson(file){
                const response = await fetch(file);
                const data = await response.text();
                var Json_data = csvJSON(data);
                var JsonData = JSON.parse(Json_data);
                return JsonData
            }
            
            function JsonVisData(data_act1, visdata, checking){
                labels = {};
                visdata.clear();
                if (checking == true){
                    data_act1.splice(data_act1.length-1, 1);
                }
                data_act1.forEach(row => {
                    const Dat = parseInt(row.Time.substring(0, 2));
                    const Month = parseInt(row.Time.substring(3, 5));
                    const Year = parseInt(row.Time.substring(6, 10));
                    const Hour = parseInt(row.Time.substring(11, 13));
                    const Min = parseInt(row.Time.substring(14, 16));
                    const Sec = parseInt(row.Time.substring(17, 19));
                    const Nsec = parseInt(row.Time.substring(20, ));
                    const Msec = parseInt(Nsec/Math.pow(10, 6));
                    const DateTime = new Date(Year, Month-1, Dat, Hour, Min, Sec, Msec);
                    const Topic = row.Topic;
                    const Msg = row.Message;
                    const Color = row.Color;
                    const Title = '<table border="1"><tr><td>Topic : '+ Topic + '</td></tr><tr><td>Message : ' + Msg + '</td></tr><tr><td>Timestamp : ' + row.Time + '</td></tr></table>';
                    var items = [{start:DateTime, content: "", className: Color, title: Title, selectable: true, editable:{remove:false}}];
                    labels["  " + Topic] = Color;
                    visdata.add(items);
                    if (checking == true){
                        checkbox_array.push("check_" + Topic);
                    }
                });
                if (checking == true){
                    checkMain(checkbox_array);
                }
                return visdata;
            }

            function checkMain(checkbox_array){
                document.getElementById('container').innerHTML = "";
                checkbox_array = Array.from(new Set(checkbox_array))
                checkbox_array.forEach(ele => {
                    addCheckbox(ele.substring(6,));
                });  
            }

            var options = {
                editable: true
            };

            function chart(visdata){
                // create the timeline
                document.getElementById('visualization').innerHTML = "";
                var container = document.getElementById("visualization");
                timeline = new vis.Timeline(container, visdata, options);
                colorize(labels);
            }

            function colorize(colorList) {
                var container = document.getElementById('legend');
                document.getElementById('legend').innerHTML = "";                
                for (var key in colorList) {
                    var boxContainer = document.createElement("DIV");
                    var box = document.createElement("DIV");
                    var label = document.createElement("SPAN");

                    label.innerHTML = key;
                    box.className = "box";
                    box.style.backgroundColor = colorList[key];

                    boxContainer.appendChild(box);
                    boxContainer.appendChild(label);
                    container.appendChild(boxContainer);
                }
            }

            function checkboxClick(){
                stringTopic = [];
                selectedTopic = []; 
                checkbox_array.forEach(ele => {
                    var checkBox = document.getElementById(ele);
                    if (checkBox.checked == true){
                        selectedTopic.push(ele)
                    } else {                    
                    }
                });
                stringTopic = checkbox_array.filter(function(obj) { return selectedTopic.indexOf(obj) == -1; });
                return stringTopic;
            }

            function addCheckbox(Topic){    
                var node = document.createElement('div');        
                node.innerHTML = '<input type="checkbox" checked=true id="check_' + Topic + '" name="check' + Topic + '"onclick="checkboxClick()"><label for="check' + Topic + '">'+ Topic +'</label>';       
                document.getElementById('container').appendChild(node);
            }

            function selectAll(){
                var selectall = document.getElementById('selectall');
                if (selectall.checked == true){
                    checkbox_array.forEach(ele => {
                        document.getElementById(ele).checked = true;
                    });
                } else {
                    checkbox_array.forEach(ele => {
                        document.getElementById(ele).checked = false;
                    });            
                }
                checkboxClick();
            }

        </script>
    </body>
</html>